// === DATI DELLE ZONE ===
const DB_ZONE = {
  "Zona A": [
    { street: "Castellana", civici: ["26"] },
    {
      street: "Hayez",
      civici: ["32", "17a", "17", "15", "13", "11", "9", "7", "5", "3"],
    },
    {
      street: "Caravaglio",
      civici: ["42", "40"],
    },
    {
      street: "Hayez",
      civici: ["4p", "4g", "4b", "4a", "17b", "17c", "19", "21"],
    },
    {
      street: "Caravaglio",
      civici: ["11", "9", "7", "5a", "5", "3"],
    },
    {
      street: "Castellana",
      civici: [
        "26a",
        "28",
        "30",
        "30a",
        "30b",
        "67",
        "65h",
        "65g",
        "65f",
        "65e",
        "65d",
        "65c",
        "65b",
        "65a",
        "65",
      ],
    },
    {
      street: "Guardi",
      civici: [
        "2",
        "4",
        "6",
        "8",
        "10",
        "12",
        "14",
        "16",
        "18",
        "20",
        "21",
        "19",
        "17",
        "15",
        "13",
        "11",
        "9",
        "7",
        "5",
        "3",
        "1",
      ],
    },
    {
      street: "Castellana",
      civici: ["63n", "34", "34b", "34c", "34d"],
    },
    {
      street: "Bellotto",
      civici: [
        "2",
        "2a",
        "2b",
        "2c",
        "4",
        "4a",
        "4b",
        "6",
        "8",
        "8a",
        "8b",
        "8c",
        "10",
        "12",
        "12a",
        "12b",
        "12c",
        "14",
        "14a",
        "14b",
        "16",
        "16a",
        "18",
        "18a",
        "18b",
        "18c",
        "18d",
        "20",
        "22",
        "30",
        "32",
        "5",
        "3",
      ],
    },
    {
      street: "Castellana",
      civici: ["40", "23", "44", "46", "48", "48a", "50", "52", "56"],
    },
    {
      street: "Pittoni",
      civici: [
        "2",
        "4",
        "6",
        "8",
        "10",
        "10a",
        "21",
        "19",
        "17",
        "15",
        "13",
        "11",
        "9",
        "7",
        "5",
        "3",
      ],
    },
    { street: "Castellana", civici: ["58", "58a", "58b", "58g", "58h", "58d"] },
    {
      street: "Giambellino",
      civici: [
        "4",
        "6",
        "8",
        "10",
        "12",
        "15",
        "13",
        "11",
        "9",
        "7",
        "5",
        "3",
        "1a",
        "1",
      ],
    },
    { street: "Castellana", civici: ["93b"] },
    {
      street: "Marzenego",
      civici: [
        "2",
        "4",
        "6",
        "8",
        "10",
        "12",
        "15",
        "13",
        "11",
        "9",
        "7",
        "3",
        "1",
      ],
    },
    {
      street: "Molino Ronchin",
      civici: [
        "2",
        "2a",
        "2b",
        "2c",
        "2d",
        "4",
        "6",
        "8",
        "10",
        "10a",
        "10b",
        "10c",
        "7",
        "5",
        "3",
        "1",
      ],
    },
    {
      street: "Castellana",
      civici: [
        "93a",
        "93",
        "87p",
        "87a",
        "87",
        "85",
        "83a",
        "83",
        "81",
        "79",
        "77",
        "75",
        "71",
        "69a",
        "69",
        "32",
      ],
    },
    {
      street: "Ricci",
      civici: ["19", "17", "15", "13", "11", "9", "7", "5", "1"],
    },
    { street: "Castellana", civici: ["32a", "32b", "32c"] },
    {
      street: "Piranesi",
      civici: [
        "2",
        "4",
        "6",
        "8",
        "10",
        "12",
        "14",
        "16",
        "18",
        "20",
        "22",
        "26",
        "27",
        "25",
        "23",
        "21",
        "19",
        "17a",
        "17",
        "15",
        "13",
        "11",
        "9",
        "7",
        "5",
        "3",
        "1",
        "2",
      ],
    },
    {
      street: "Piazzetta",
      civici: [
        "4",
        "6",
        "8",
        "10",
        "12",
        "14",
        "16",
        "18",
        "20",
        "22",
        "24",
        "26",
        "28",
        "29",
        "27",
        "25b",
        "25a",
        "25",
        "23",
        "21",
        "19",
        "17",
        "15",
        "13a",
        "13",
        "11",
        "9",
        "7",
        "5",
        "3",
        "1",
      ],
    },
    {
      street: "Castellana",
      civici: [
        "63i",
        "63l",
        "63b",
        "63d",
        "63e",
        "63f",
        "63g",
        "63h",
        "63",
        "61u",
        "61t",
        "61s",
        "61r",
        "61q",
        "61p",
        "61n",
        "61m",
        "61l",
        "61h",
        "61i",
        "61g",
        "61e",
        "61f",
        "61b",
        "61a",
        "61",
        "59c",
        "59",
        "57",
        "55",
        "53",
        "51",
        "49",
        "47",
        "45",
        "43",
        "41",
        "39",
        "37",
        "35b",
        "35a",
        "35",
        "33",
        "31",
        "29",
        "27d",
        "27c",
        "27b",
        "27a",
        "27",
        "25m",
        "25l",
        "25i",
        "25h",
        "25g",
        "25f",
      ],
    },
    {
      street: "Gaggian",
      civici: [
        "10",
        "12",
        "14",
        "14a",
        "16",
        "18",
        "20",
        "22",
        "24",
        "15",
        "13",
        "11",
        "9",
        "7",
        "5",
        "3",
        "1",
      ],
    },
    {
      street: "Castellana",
      civici: ["25e", "25d", "25c", "25b", "25a", "25", "23l", "23h", "23g"],
    },
    {
      street: "Cima",
      civici: [
        "4",
        "6",
        "8",
        "10",
        "12",
        "14",
        "19",
        "17",
        "15",
        "13",
        "11",
        "9",
        "7",
        "5",
        "3",
        "1",
      ],
    },
    { street: "Castellana", civici: ["23c", "23b", "23"] },
    {
      street: "Pordenone",
      civici: [
        "2",
        "4",
        "6",
        "8",
        "10",
        "12",
        "14",
        "16",
        "18",
        "20",
        "22",
        "24",
        "26",
        "27",
        "25",
        "23",
        "21a",
        "21",
        "19",
        "17",
        "15",
        "13",
        "11",
        "9",
        "7",
        "5",
        "3",
        "1a",
        "1",
      ],
    },
    { street: "Castellana", civici: ["21a"] },
    {
      street: "Buzzola",
      civici: [
        "2",
        "4",
        "6",
        "8",
        "10",
        "12",
        "14",
        "16",
        "18",
        "20",
        "22",
        "24",
        "26",
        "28",
        "30",
        "31",
        "29",
        "27",
        "25",
        "23",
        "21",
        "19",
        "17",
        "15",
        "13",
        "11",
        "9",
        "7",
        "5",
        "3",
        "1",
      ],
    },
    { street: "Castellana", civici: ["21", "19", "17c", "17b"] },
    {
      street: "Giorgione",
      civici: [
        "2",
        "4",
        "6",
        "8",
        "10",
        "12",
        "14",
        "16",
        "18",
        "20",
        "22",
        "15",
        "13",
        "11",
        "9",
        "7",
        "5",
        "3",
        "1",
      ],
    },
    { street: "Castellana", civici: ["17a", "17", "15", "13"] },
  ],
  "Zona B": [
    // Esempio di una seconda zona
    { street: "Via Roma", civici: ["1", "2", "3"] },
    { street: "Via Milano", civici: ["10", "20"] },
  ],
};

// --- STATO APPLICAZIONE ---
let currentZoneName = localStorage.getItem("lastZone") || "Zona A";
let deliveries = [];

const ui = {
  title: document.getElementById("pageTitle"),
  sidebar: document.getElementById("sidebar"),
  overlay: document.getElementById("sidebar-overlay"),
  select: document.getElementById("streetSelect"),
  input: document.getElementById("civicoInput"),
  list: document.getElementById("deliveryList"),
  addBtn: document.getElementById("addBtn"),
  zoneBtns: document.querySelectorAll(".zone-btn"),
  voiceToggle: document.getElementById("voiceToggle"),
};

// === INIZIALIZZAZIONE ===
function init() {
  loadZone(currentZoneName);
  ui.addBtn.addEventListener("click", addDelivery);
  ui.input.addEventListener("keypress", (e) => {
    if (e.key === "Enter") addDelivery();
  });

  // Sblocco audio per iOS: la prima interazione dell'utente abilita la voce
  document.addEventListener(
    "click",
    function unlockAudio() {
      if ("speechSynthesis" in window) {
        const silent = new SpeechSynthesisUtterance("");
        window.speechSynthesis.speak(silent);
      }
      document.removeEventListener("click", unlockAudio);
    },
    { once: true }
  );

  // Gestione impostazione voce (salvataggio locale)
  const voicePref = localStorage.getItem("voiceEnabled");
  ui.voiceToggle.checked = voicePref === null ? true : JSON.parse(voicePref);
  ui.voiceToggle.addEventListener("change", () => {
    localStorage.setItem("voiceEnabled", ui.voiceToggle.checked);
    if (!ui.voiceToggle.checked) window.speechSynthesis.cancel();
  });

  // Pulsante attivazione notifiche (per iOS PWA)
  setupNotificationButton();
}

function setupNotificationButton() {
  if ("Notification" in window && Notification.permission !== "granted") {
    const notifBtn = document.createElement("button");
    notifBtn.textContent = "üîî Attiva Notifiche iPhone";
    notifBtn.className = "action-btn";
    notifBtn.style.backgroundColor = "#ffc107";
    notifBtn.onclick = () => {
      Notification.requestPermission().then((permission) => {
        if (permission === "granted") {
          notifBtn.remove();
          alert("Notifiche attivate correttamente!");
        }
      });
    };
    document.querySelector(".sidebar-content").appendChild(notifBtn);
  }
}

// === LOGICA ZONE ===
function loadZone(zoneName) {
  currentZoneName = zoneName;
  localStorage.setItem("lastZone", zoneName);
  ui.title.textContent = zoneName;
  ui.zoneBtns.forEach((btn) =>
    btn.classList.toggle("active", btn.textContent.includes(zoneName))
  );
  const savedData = localStorage.getItem(`deliveries_${zoneName}`);
  deliveries = savedData ? JSON.parse(savedData) : [];
  populateSelect();
  renderList();
  toggleSidebar(false);
}

function switchZone(zoneName) {
  if (confirm(`Passare a ${zoneName}?`)) loadZone(zoneName);
}

function clearZone() {
  if (confirm(`Cancellare tutte le consegne di ${currentZoneName}?`)) {
    deliveries = [];
    saveData();
    renderList();
    toggleSidebar(false);
  }
}

function populateSelect() {
  const routes = DB_ZONE[currentZoneName];
  const streetNames = [...new Set(routes.map((r) => r.street))].sort();
  ui.select.innerHTML =
    '<option value="" disabled selected>Seleziona Via...</option>';
  streetNames.forEach((street) => {
    const opt = document.createElement("option");
    opt.value = street;
    opt.textContent = street;
    ui.select.appendChild(opt);
  });
}

// === AGGIUNTA E VALIDAZIONE ===
function addDelivery() {
  const street = ui.select.value;
  const civico = ui.input.value.trim();
  if (!street || !civico) return;

  const isValid = checkCivico(street, civico);
  const newDelivery = {
    street,
    civico,
    isValid,
    completed: false,
    timestamp: Date.now(),
  };
  deliveries.push(newDelivery);
  sortDeliveries();
  saveData();
  renderList();
  ui.input.value = "";
  ui.input.focus();
}

function checkCivico(streetName, civicoVal) {
  const routes = DB_ZONE[currentZoneName];
  const streetData = routes.filter((r) => r.street === streetName);
  return streetData.some((entry) => entry.civici.includes(civicoVal));
}

function sortDeliveries() {
  const routeOrder = DB_ZONE[currentZoneName];
  deliveries.sort(
    (a, b) => getOrderIndex(a, routeOrder) - getOrderIndex(b, routeOrder)
  );
}

function getOrderIndex(delivery, routeRef) {
  for (let i = 0; i < routeRef.length; i++) {
    if (routeRef[i].street === delivery.street) {
      const civIndex = routeRef[i].civici.indexOf(delivery.civico);
      if (civIndex !== -1) return i * 1000 + civIndex;
    }
  }
  const sIdx = routeRef.findIndex((r) => r.street === delivery.street);
  return sIdx !== -1 ? sIdx * 1000 + 999 : 999999;
}

// === RENDERING E NOTIFICHE ===
function renderList() {
  ui.list.innerHTML = "";
  deliveries.forEach((item, index) => {
    const card = document.createElement("div");
    card.className = `delivery-card ${item.completed ? "completed" : ""} ${
      !item.isValid ? "error-card" : ""
    }`;
    card.innerHTML = `
            <div class="delivery-info">
                <span class="delivery-street">${item.street}</span>
                <span class="delivery-number">${item.civico}</span>
                ${
                  !item.isValid
                    ? '<span style="color:#dc3545; font-size:12px;">‚ö†Ô∏è Civico ignoto</span>'
                    : ""
                }
            </div>
            <button class="status-btn" onclick="toggleComplete(${index})">${
      item.completed ? "‚Ü©Ô∏è" : "‚úÖ"
    }</button>
        `;
    ui.list.appendChild(card);
  });
}

function toggleComplete(index) {
  // Svuota coda audio precedente (necessario per iOS)
  if ("speechSynthesis" in window) window.speechSynthesis.cancel();

  const item = deliveries[index];
  item.completed = !item.completed;
  saveData();
  renderList();

  if (item.completed) {
    // Breve ritardo per stabilit√† iOS
    setTimeout(trovaEAvvisaProssimo, 200);
  }
}

function trovaEAvvisaProssimo() {
    // Trova il prossimo pacco da consegnare
    const prossimo = deliveries.find(d => !d.completed);
    const isVoiceEnabled = ui.voiceToggle.checked;

    if (prossimo) {
        const msg = `${prossimo.street} ${prossimo.civico}`;
        
        // --- NOTIFICA CON RITARDO DI 3 SECONDI ---
        setTimeout(() => {
            if (Notification.permission === "granted") {
                new Notification("üì¶ Prossimo:", { 
                    body: msg,
                    tag: "delivery-update", // Sostituisce la vecchia notifica
                    renotify: true,
                    silent: false
                });
            }
        }, 3000); // 3000ms = 3 secondi

        // --- VOCE (Puoi decidere se farla parlare subito o dopo) ---
        // In questo esempio la voce parla subito appena clicchi
        if (isVoiceEnabled && 'speechSynthesis' in window) {
            const utter = new SpeechSynthesisUtterance(msg);
            utter.lang = 'it-IT';
            window.speechSynthesis.speak(utter);
        }
    } else {
        // Fine del giro
        if (isVoiceEnabled && 'speechSynthesis' in window) {
            window.speechSynthesis.speak(new SpeechSynthesisUtterance("Giro completato!"));
        }
    }
}

// === UTILS ===
function saveData() {
  localStorage.setItem(
    `deliveries_${currentZoneName}`,
    JSON.stringify(deliveries)
  );
}

function toggleSidebar(state) {
  const isOpen = ui.sidebar.classList.contains("active");
  const newState = state !== undefined ? state : !isOpen;
  ui.sidebar.classList.toggle("active", newState);
  ui.overlay.classList.toggle("active", newState);
}

function printList() {
  window.print();
}

init();

