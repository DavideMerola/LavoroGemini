// === DATI DELLE ZONE ===
const DB_ZONE = {
  "Zona A": [
    { street: "Castellana", civici: ["26"] },
    {
      street: "Hayez",
      civici: ["32", "17a", "17", "15", "13", "11", "9", "7", "5", "3"],
    },
    { street: "Caravaglio", civici: ["42", "40"] },
    {
      street: "Hayez",
      civici: ["4p", "4g", "4b", "4a", "17b", "17c", "19", "21"],
    },
    { street: "Caravaglio", civici: ["11", "9", "7", "5a", "5", "3"] },
    {
      street: "Castellana",
      civici: [
        "26a",
        "28",
        "30",
        "30a",
        "30b",
        "67",
        "65h",
        "65g",
        "65f",
        "65e",
        "65d",
        "65c",
        "65b",
        "65a",
        "65",
      ],
    },
    {
      street: "Guardi",
      civici: [
        "2",
        "4",
        "6",
        "8",
        "10",
        "12",
        "14",
        "16",
        "18",
        "20",
        "21",
        "19",
        "17",
        "15",
        "13",
        "11",
        "9",
        "7",
        "5",
        "3",
        "1",
      ],
    },
    { street: "Castellana", civici: ["63n", "34", "34b", "34c", "34d"] },
    {
      street: "Bellotto",
      civici: [
        "2",
        "2a",
        "2b",
        "2c",
        "4",
        "4a",
        "4b",
        "6",
        "8",
        "8a",
        "8b",
        "8c",
        "10",
        "12",
        "12a",
        "12b",
        "12c",
        "14",
        "14a",
        "14b",
        "16",
        "16a",
        "18",
        "18a",
        "18b",
        "18c",
        "18d",
        "20",
        "22",
        "30",
        "32",
        "5",
        "3",
      ],
    },
    {
      street: "Castellana",
      civici: ["40", "23", "44", "46", "48", "48a", "50", "52", "56"],
    },
    {
      street: "Pittoni",
      civici: [
        "2",
        "4",
        "6",
        "8",
        "10",
        "10a",
        "21",
        "19",
        "17",
        "15",
        "13",
        "11",
        "9",
        "7",
        "5",
        "3",
      ],
    },
    { street: "Castellana", civici: ["58", "58a", "58b", "58g", "58h", "58d"] },
    {
      street: "Giambellino",
      civici: [
        "4",
        "6",
        "8",
        "10",
        "12",
        "15",
        "13",
        "11",
        "9",
        "7",
        "5",
        "3",
        "1a",
        "1",
      ],
    },
    { street: "Castellana", civici: ["93b"] },
    {
      street: "Marzenego",
      civici: [
        "2",
        "4",
        "6",
        "8",
        "10",
        "12",
        "15",
        "13",
        "11",
        "9",
        "7",
        "3",
        "1",
      ],
    },
    {
      street: "Molino Ronchin",
      civici: [
        "2",
        "2a",
        "2b",
        "2c",
        "2d",
        "4",
        "6",
        "8",
        "10",
        "10a",
        "10b",
        "10c",
        "7",
        "5",
        "3",
        "1",
      ],
    },
    {
      street: "Castellana",
      civici: [
        "93a",
        "93",
        "87p",
        "87a",
        "87",
        "85",
        "83a",
        "83",
        "81",
        "79",
        "77",
        "75",
        "71",
        "69a",
        "69",
        "32",
      ],
    },
    {
      street: "Ricci",
      civici: ["19", "17", "15", "13", "11", "9", "7", "5", "1"],
    },
    { street: "Castellana", civici: ["32a", "32b", "32c"] },
    {
      street: "Piranesi",
      civici: [
        "2",
        "4",
        "6",
        "8",
        "10",
        "12",
        "14",
        "16",
        "18",
        "20",
        "22",
        "26",
        "27",
        "25",
        "23",
        "21",
        "19",
        "17a",
        "17",
        "15",
        "13",
        "11",
        "9",
        "7",
        "5",
        "3",
        "1",
        "2",
      ],
    },
    {
      street: "Piazzetta",
      civici: [
        "4",
        "6",
        "8",
        "10",
        "12",
        "14",
        "16",
        "18",
        "20",
        "22",
        "24",
        "26",
        "28",
        "29",
        "27",
        "25b",
        "25a",
        "25",
        "23",
        "21",
        "19",
        "17",
        "15",
        "13a",
        "13",
        "11",
        "9",
        "7",
        "5",
        "3",
        "1",
      ],
    },
    {
      street: "Castellana",
      civici: [
        "63i",
        "63l",
        "63b",
        "63d",
        "63e",
        "63f",
        "63g",
        "63h",
        "63",
        "61u",
        "61t",
        "61s",
        "61r",
        "61q",
        "61p",
        "61n",
        "61m",
        "61l",
        "61h",
        "61i",
        "61g",
        "61e",
        "61f",
        "61b",
        "61a",
        "61",
        "59c",
        "59",
        "57",
        "55",
        "53",
        "51",
        "49",
        "47",
        "45",
        "43",
        "41",
        "39",
        "37",
        "35b",
        "35a",
        "35",
        "33",
        "31",
        "29",
        "27d",
        "27c",
        "27b",
        "27a",
        "27",
        "25m",
        "25l",
        "25i",
        "25h",
        "25g",
        "25f",
      ],
    },
    {
      street: "Gaggian",
      civici: [
        "10",
        "12",
        "14",
        "14a",
        "16",
        "18",
        "20",
        "22",
        "24",
        "15",
        "13",
        "11",
        "9",
        "7",
        "5",
        "3",
        "1",
      ],
    },
    {
      street: "Castellana",
      civici: ["25e", "25d", "25c", "25b", "25a", "25", "23l", "23h", "23g"],
    },
    {
      street: "Cima",
      civici: [
        "4",
        "6",
        "8",
        "10",
        "12",
        "14",
        "19",
        "17",
        "15",
        "13",
        "11",
        "9",
        "7",
        "5",
        "3",
        "1",
      ],
    },
    { street: "Castellana", civici: ["23c", "23b", "23"] },
    {
      street: "Pordenone",
      civici: [
        "2",
        "4",
        "6",
        "8",
        "10",
        "12",
        "14",
        "16",
        "18",
        "20",
        "22",
        "24",
        "26",
        "27",
        "25",
        "23",
        "21a",
        "21",
        "19",
        "17",
        "15",
        "13",
        "11",
        "9",
        "7",
        "5",
        "3",
        "1a",
        "1",
      ],
    },
    { street: "Castellana", civici: ["21a"] },
    {
      street: "Buzzola",
      civici: [
        "2",
        "4",
        "6",
        "8",
        "10",
        "12",
        "14",
        "16",
        "18",
        "20",
        "22",
        "24",
        "26",
        "28",
        "30",
        "31",
        "29",
        "27",
        "25",
        "23",
        "21",
        "19",
        "17",
        "15",
        "13",
        "11",
        "9",
        "7",
        "5",
        "3",
        "1",
      ],
    },
    { street: "Castellana", civici: ["21", "19", "17c", "17b"] },
    {
      street: "Giorgione",
      civici: [
        "2",
        "4",
        "6",
        "8",
        "10",
        "12",
        "14",
        "16",
        "18",
        "20",
        "22",
        "15",
        "13",
        "11",
        "9",
        "7",
        "5",
        "3",
        "1",
      ],
    },
    { street: "Castellana", civici: ["17a", "17", "15", "13"] },
  ],
  "Zona B": [
    { street: "Via Roma", civici: ["1", "2", "3"] },
    { street: "Via Milano", civici: ["10", "20"] },
  ],
};

// --- STATO APPLICAZIONE ---
let currentZoneName = localStorage.getItem("lastZone") || "Zona A";
let deliveries = [];
let audioSilenzioso = new Audio(
  "https://github.com/anars/blank-audio/raw/master/10-seconds-of-silence.mp3"
);
audioSilenzioso.loop = true;

// Elementi DOM
const ui = {
  title: document.getElementById("pageTitle"),
  sidebar: document.getElementById("sidebar"),
  overlay: document.getElementById("sidebar-overlay"),
  select: document.getElementById("streetSelect"),
  input: document.getElementById("civicoInput"),
  pacchiInput: document.getElementById("pacchiInput"), // NUOVO
  list: document.getElementById("deliveryList"),
  addBtn: document.getElementById("addBtn"),
  zoneBtns: document.querySelectorAll(".zone-btn"),
  voiceToggle: document.getElementById("voiceToggle"), // NUOVO
};

// --- INIZIALIZZAZIONE ---
function init() {
  loadZone(currentZoneName);

  // Event Listeners
  ui.addBtn.addEventListener("click", addDelivery);
  ui.input.addEventListener("keypress", (e) => {
    if (e.key === "Enter") addDelivery();
  });

  // Sblocco audio e MediaSession al primo tocco
  document.addEventListener(
    "click",
    () => {
      audioSilenzioso.play().then(() => audioSilenzioso.pause());
    },
    { once: true }
  );

  // Configurazione Apple Watch (Media Session)
  if ("mediaSession" in navigator) {
    navigator.mediaSession.setActionHandler("nexttrack", () => {
      completamentoRemoto();
    });
    navigator.mediaSession.setActionHandler("play", () => {
      audioSilenzioso.play();
      trovaEAvvisaProssimo();
    });
  }

  // Carica preferenza voce
  const vPref = localStorage.getItem("voiceEnabled");
  if (ui.voiceToggle) {
    ui.voiceToggle.checked = vPref === null ? true : JSON.parse(vPref);
    ui.voiceToggle.addEventListener("change", () =>
      localStorage.setItem("voiceEnabled", ui.voiceToggle.checked)
    );
  }
}

// --- GESTIONE ZONE ---
function loadZone(zoneName) {
  currentZoneName = zoneName;
  localStorage.setItem("lastZone", zoneName);
  ui.title.textContent = zoneName;

  ui.zoneBtns.forEach((btn) => {
    btn.classList.toggle("active", btn.textContent.includes(zoneName));
  });

  const savedData = localStorage.getItem(`deliveries_${zoneName}`);
  deliveries = savedData ? JSON.parse(savedData) : [];

  populateSelect();
  renderList();
  toggleSidebar(false);
}

function switchZone(zoneName) {
  if (confirm(`Passare a ${zoneName}?`)) {
    loadZone(zoneName);
  }
}

function clearZone() {
  if (confirm(`Cancellare tutte le consegne di ${currentZoneName}?`)) {
    deliveries = [];
    saveData();
    renderList();
    if ("mediaSession" in navigator) audioSilenzioso.pause();
    toggleSidebar(false);
  }
}

// --- GESTIONE STRADE (SELECT) ---
function populateSelect() {
  const routes = DB_ZONE[currentZoneName];
  const streetNames = [...new Set(routes.map((r) => r.street))].sort();

  ui.select.innerHTML =
    '<option value="" disabled selected>Seleziona Via...</option>';
  streetNames.forEach((street) => {
    const opt = document.createElement("option");
    opt.value = street;
    opt.textContent = street;
    ui.select.appendChild(opt);
  });
}

// --- LOGICA AGGIUNTA E VALIDAZIONE ---
function addDelivery() {
  const street = ui.select.value;
  const civicoBase = ui.input.value.trim();
  const qtaPacchi = ui.pacchiInput ? ui.pacchiInput.value.trim() : "";

  if (!street) return alert("Seleziona una via!");
  if (!civicoBase) return alert("Inserisci il civico!");

  // Formattazione display (es: "22 (3p)")
  const civicoDisplay = qtaPacchi
    ? `${civicoBase} (${qtaPacchi}p)`
    : civicoBase;

  // Validazione su civico base
  const isValid = checkCivico(street, civicoBase);

  const newDelivery = {
    street,
    civico: civicoDisplay,
    civicoBase: civicoBase, // Teniamo il base per l'ordinamento
    isValid,
    completed: false,
    timestamp: Date.now(),
  };

  deliveries.push(newDelivery);
  sortDeliveries();
  saveData();
  renderList();

  ui.input.value = "";
  if (ui.pacchiInput) ui.pacchiInput.value = "";
  ui.input.focus();
}

function checkCivico(streetName, civicoVal) {
  const routes = DB_ZONE[currentZoneName];
  const streetData = routes.filter((r) => r.street === streetName);
  if (streetData.length === 0) return false;

  return streetData.some((entry) =>
    entry.civici.some((c) => c.toLowerCase() === civicoVal.toLowerCase())
  );
}

// --- ORDINAMENTO (Logica Primo Codice) ---
function sortDeliveries() {
  const routeOrder = DB_ZONE[currentZoneName];
  deliveries.sort((a, b) => {
    const idxA = getOrderIndex(a, routeOrder);
    const idxB = getOrderIndex(b, routeOrder);
    return idxA - idxB;
  });
}

function getOrderIndex(delivery, routeRef) {
  // Usiamo civicoBase per il confronto con il DB
  const cBase = delivery.civicoBase.toLowerCase();

  for (let i = 0; i < routeRef.length; i++) {
    const entry = routeRef[i];
    if (entry.street === delivery.street) {
      const civIndex = entry.civici.findIndex((c) => c.toLowerCase() === cBase);
      if (civIndex !== -1) {
        return i * 1000 + civIndex;
      }
    }
  }
  const streetGenericIndex = routeRef.findIndex(
    (r) => r.street === delivery.street
  );
  return streetGenericIndex !== -1 ? streetGenericIndex * 1000 + 999 : 999999;
}

// --- RENDERING LISTA ---
function renderList() {
  ui.list.innerHTML = "";
  deliveries.forEach((item, index) => {
    const card = document.createElement("div");
    card.className = `delivery-card ${item.completed ? "completed" : ""} ${
      !item.isValid ? "error-card" : ""
    }`;

    card.innerHTML = `
      <div class="delivery-info">
          <span class="delivery-street">${item.street}</span>
          <span class="delivery-number">${item.civico}</span>
          ${
            !item.isValid
              ? '<span style="color:#dc3545; font-size:12px; display:block;">‚ö†Ô∏è Sconosciuto</span>'
              : ""
          }
      </div>
      <button class="status-btn" onclick="toggleComplete(${index})">${
      item.completed ? "‚Ü©Ô∏è" : "‚úÖ"
    }</button>
    `;
    ui.list.appendChild(card);
  });
}

// --- COMPLETAMENTO E FEEDBACK ---
function toggleComplete(index) {
  deliveries[index].completed = !deliveries[index].completed;
  saveData();
  renderList();
  if (deliveries[index].completed) {
    trovaEAvvisaProssimo();
  }
}

function completamentoRemoto() {
  const indiceProssimo = deliveries.findIndex((d) => !d.completed);
  if (indiceProssimo !== -1) {
    toggleComplete(indiceProssimo);
  }
}

function trovaEAvvisaProssimo() {
  const prossimo = deliveries.find((d) => !d.completed);

  if (prossimo) {
    const infoWatch = `üì¶ ${prossimo.civico} - ${prossimo.street}`;

    // Update Apple Watch / Control Center
    if ("mediaSession" in navigator) {
      navigator.mediaSession.metadata = new MediaMetadata({
        title: infoWatch,
        artist: "Prossima Consegna",
        album: currentZoneName,
      });
      audioSilenzioso.play();
    }

    // Sintesi Vocale
    if (
      ui.voiceToggle &&
      ui.voiceToggle.checked &&
      "speechSynthesis" in window
    ) {
      window.speechSynthesis.cancel();
      const utter = new SpeechSynthesisUtterance(
        `${prossimo.street} ${prossimo.civico}`
      );
      utter.lang = "it-IT";
      window.speechSynthesis.speak(utter);
    }
  } else {
    if ("mediaSession" in navigator) {
      navigator.mediaSession.metadata = new MediaMetadata({
        title: "Giro Completato! ‚úÖ",
      });
      audioSilenzioso.pause();
    }
  }
}

// --- UTILS ---
function saveData() {
  localStorage.setItem(
    `deliveries_${currentZoneName}`,
    JSON.stringify(deliveries)
  );
}

function toggleSidebar(forceState) {
  const isOpen = ui.sidebar.classList.contains("active");
  const newState = forceState !== undefined ? forceState : !isOpen;
  ui.sidebar.classList.toggle("active", newState);
  ui.overlay.classList.toggle("active", newState);
}

function printList() {
  window.print();
}

init();
