// === DATI DELLE ZONE ===
const DB_ZONE = {
  "Zona A": [
    { street: "Castellana", civici: ["26"] },
    {
      street: "Hayez",
      civici: ["32", "17a", "17", "15", "13", "11", "9", "7", "5", "3"],
    },
    {
      street: "Caravaglio",
      civici: ["42", "40"],
    },
    {
      street: "Hayez",
      civici: ["4p", "4g", "4b", "4a", "17b", "17c", "19", "21"],
    },
    {
      street: "Caravaglio",
      civici: ["11", "9", "7", "5a", "5", "3"],
    },
    {
      street: "Castellana",
      civici: [
        "26a",
        "28",
        "30",
        "30a",
        "30b",
        "67",
        "65h",
        "65g",
        "65f",
        "65e",
        "65d",
        "65c",
        "65b",
        "65a",
        "65",
      ],
    },
    {
      street: "Guardi",
      civici: [
        "2",
        "4",
        "6",
        "8",
        "10",
        "12",
        "14",
        "16",
        "18",
        "20",
        "21",
        "19",
        "17",
        "15",
        "13",
        "11",
        "9",
        "7",
        "5",
        "3",
        "1",
      ],
    },
    {
      street: "Castellana",
      civici: ["63n", "34", "34b", "34c", "34d"],
    },
    {
      street: "Bellotto",
      civici: [
        "2",
        "2a",
        "2b",
        "2c",
        "4",
        "4a",
        "4b",
        "6",
        "8",
        "8a",
        "8b",
        "8c",
        "10",
        "12",
        "12a",
        "12b",
        "12c",
        "14",
        "14a",
        "14b",
        "16",
        "16a",
        "18",
        "18a",
        "18b",
        "18c",
        "18d",
        "20",
        "22",
        "30",
        "32",
        "5",
        "3",
      ],
    },
    {
      street: "Castellana",
      civici: ["40", "23", "44", "46", "48", "48a", "50", "52", "56"],
    },
    {
      street: "Pittoni",
      civici: [
        "2",
        "4",
        "6",
        "8",
        "10",
        "10a",
        "21",
        "19",
        "17",
        "15",
        "13",
        "11",
        "9",
        "7",
        "5",
        "3",
      ],
    },
    { street: "Castellana", civici: ["58", "58a", "58b", "58g", "58h", "58d"] },
    {
      street: "Giambellino",
      civici: [
        "4",
        "6",
        "8",
        "10",
        "12",
        "15",
        "13",
        "11",
        "9",
        "7",
        "5",
        "3",
        "1a",
        "1",
      ],
    },
    { street: "Castellana", civici: ["93b"] },
    {
      street: "Marzenego",
      civici: [
        "2",
        "4",
        "6",
        "8",
        "10",
        "12",
        "15",
        "13",
        "11",
        "9",
        "7",
        "3",
        "1",
      ],
    },
    {
      street: "Molino Ronchin",
      civici: [
        "2",
        "2a",
        "2b",
        "2c",
        "2d",
        "4",
        "6",
        "8",
        "10",
        "10a",
        "10b",
        "10c",
        "7",
        "5",
        "3",
        "1",
      ],
    },
    {
      street: "Castellana",
      civici: [
        "93a",
        "93",
        "87p",
        "87a",
        "87",
        "85",
        "83a",
        "83",
        "81",
        "79",
        "77",
        "75",
        "71",
        "69a",
        "69",
        "32",
      ],
    },
    {
      street: "Ricci",
      civici: ["19", "17", "15", "13", "11", "9", "7", "5", "1"],
    },
    { street: "Castellana", civici: ["32a", "32b", "32c"] },
    {
      street: "Piranesi",
      civici: [
        "2",
        "4",
        "6",
        "8",
        "10",
        "12",
        "14",
        "16",
        "18",
        "20",
        "22",
        "26",
        "27",
        "25",
        "23",
        "21",
        "19",
        "17a",
        "17",
        "15",
        "13",
        "11",
        "9",
        "7",
        "5",
        "3",
        "1",
        "2",
      ],
    },
    {
      street: "Piazzetta",
      civici: [
        "4",
        "6",
        "8",
        "10",
        "12",
        "14",
        "16",
        "18",
        "20",
        "22",
        "24",
        "26",
        "28",
        "29",
        "27",
        "25b",
        "25a",
        "25",
        "23",
        "21",
        "19",
        "17",
        "15",
        "13a",
        "13",
        "11",
        "9",
        "7",
        "5",
        "3",
        "1",
      ],
    },
    {
      street: "Castellana",
      civici: [
        "63i",
        "63l",
        "63b",
        "63d",
        "63e",
        "63f",
        "63g",
        "63h",
        "63",
        "61u",
        "61t",
        "61s",
        "61r",
        "61q",
        "61p",
        "61n",
        "61m",
        "61l",
        "61h",
        "61i",
        "61g",
        "61e",
        "61f",
        "61b",
        "61a",
        "61",
        "59c",
        "59",
        "57",
        "55",
        "53",
        "51",
        "49",
        "47",
        "45",
        "43",
        "41",
        "39",
        "37",
        "35b",
        "35a",
        "35",
        "33",
        "31",
        "29",
        "27d",
        "27c",
        "27b",
        "27a",
        "27",
        "25m",
        "25l",
        "25i",
        "25h",
        "25g",
        "25f",
      ],
    },
    {
      street: "Gaggian",
      civici: [
        "10",
        "12",
        "14",
        "14a",
        "16",
        "18",
        "20",
        "22",
        "24",
        "15",
        "13",
        "11",
        "9",
        "7",
        "5",
        "3",
        "1",
      ],
    },
    {
      street: "Castellana",
      civici: ["25e", "25d", "25c", "25b", "25a", "25", "23l", "23h", "23g"],
    },
    {
      street: "Cima",
      civici: [
        "4",
        "6",
        "8",
        "10",
        "12",
        "14",
        "19",
        "17",
        "15",
        "13",
        "11",
        "9",
        "7",
        "5",
        "3",
        "1",
      ],
    },
    { street: "Castellana", civici: ["23c", "23b", "23"] },
    {
      street: "Pordenone",
      civici: [
        "2",
        "4",
        "6",
        "8",
        "10",
        "12",
        "14",
        "16",
        "18",
        "20",
        "22",
        "24",
        "26",
        "27",
        "25",
        "23",
        "21a",
        "21",
        "19",
        "17",
        "15",
        "13",
        "11",
        "9",
        "7",
        "5",
        "3",
        "1a",
        "1",
      ],
    },
    { street: "Castellana", civici: ["21a"] },
    {
      street: "Buzzola",
      civici: [
        "2",
        "4",
        "6",
        "8",
        "10",
        "12",
        "14",
        "16",
        "18",
        "20",
        "22",
        "24",
        "26",
        "28",
        "30",
        "31",
        "29",
        "27",
        "25",
        "23",
        "21",
        "19",
        "17",
        "15",
        "13",
        "11",
        "9",
        "7",
        "5",
        "3",
        "1",
      ],
    },
    { street: "Castellana", civici: ["21", "19", "17c", "17b"] },
    {
      street: "Giorgione",
      civici: [
        "2",
        "4",
        "6",
        "8",
        "10",
        "12",
        "14",
        "16",
        "18",
        "20",
        "22",
        "15",
        "13",
        "11",
        "9",
        "7",
        "5",
        "3",
        "1",
      ],
    },
    { street: "Castellana", civici: ["17a", "17", "15", "13"] },
  ],
  "Zona B": [
    // Esempio di una seconda zona
    { street: "Via Roma", civici: ["1", "2", "3"] },
    { street: "Via Milano", civici: ["10", "20"] },
  ],
};

// Aggiungi questa variabile all'inizio del file
let audioSilenzioso = new Audio();

// --- STATO APPLICAZIONE ---
let currentZoneName = localStorage.getItem("lastZone") || "Zona A";
let deliveries = [];

const ui = {
  title: document.getElementById("pageTitle"),
  sidebar: document.getElementById("sidebar"),
  overlay: document.getElementById("sidebar-overlay"),
  select: document.getElementById("streetSelect"),
  input: document.getElementById("civicoInput"),
  list: document.getElementById("deliveryList"),
  addBtn: document.getElementById("addBtn"),
  zoneBtns: document.querySelectorAll(".zone-btn"),
  voiceToggle: document.getElementById("voiceToggle"),
};

// === INIZIALIZZAZIONE CON SERVICE WORKER ===
async function init() {
  loadZone(currentZoneName);
  ui.addBtn.addEventListener("click", addDelivery);
  ui.input.addEventListener("keypress", (e) => {
    if (e.key === "Enter") addDelivery();
  });

  // Registra il Service Worker (Obbligatorio per notifiche serie su iOS)
  if ("serviceWorker" in navigator) {
    try {
      await navigator.serviceWorker.register("sw.js");
      console.log("Service Worker Registrato");
    } catch (e) {
      console.log("Errore SW:", e);
    }
  }

  document.addEventListener(
    "click",
    () => {
      if ("speechSynthesis" in window) {
        window.speechSynthesis.speak(new SpeechSynthesisUtterance(""));
      }
    },
    { once: true }
  );

  const vPref = localStorage.getItem("voiceEnabled");
  ui.voiceToggle.checked = vPref === null ? true : JSON.parse(vPref);
  ui.voiceToggle.addEventListener("change", () =>
    localStorage.setItem("voiceEnabled", ui.voiceToggle.checked)
  );

  setupNotificationButton();
}

function setupNotificationButton() {
  if ("Notification" in window && Notification.permission !== "granted") {
    const btn = document.createElement("button");
    btn.textContent = "üîî ATTIVA NOTIFICHE WATCH";
    btn.className = "action-btn";
    btn.style.backgroundColor = "#ffc107";
    btn.onclick = () => {
      Notification.requestPermission().then((p) => {
        if (p === "granted") {
          btn.remove();
          inviaNotificaAlSW("Sistema Pronto", "Riceverai i civici qui");
        }
      });
    };
    document.querySelector(".sidebar-content").appendChild(btn);
  }
}

// === FUNZIONE CHIAVE PER IL WATCH ===
function inviaNotificaAlSW(titolo, messaggio) {
  if (navigator.serviceWorker.controller) {
    navigator.serviceWorker.controller.postMessage({
      type: "SHOW_NOTIFICATION",
      title: titolo,
      body: messaggio,
    });
  } else {
    // Fallback se il SW non √® ancora pronto
    new Notification(titolo, { body: messaggio });
  }
}

function loadZone(zoneName) {
  currentZoneName = zoneName;
  localStorage.setItem("lastZone", zoneName);
  ui.title.textContent = zoneName;
  ui.zoneBtns.forEach((b) =>
    b.classList.toggle("active", b.textContent.includes(zoneName))
  );
  const data = localStorage.getItem(`deliveries_${zoneName}`);
  deliveries = data ? JSON.parse(data) : [];
  populateSelect();
  renderList();
  toggleSidebar(false);
}

function switchZone(zoneName) {
  if (confirm(`Passare a ${zoneName}?`)) loadZone(zoneName);
}

function populateSelect() {
  const streets = [
    ...new Set(DB_ZONE[currentZoneName].map((r) => r.street)),
  ].sort();
  ui.select.innerHTML =
    '<option value="" disabled selected>Seleziona Via...</option>';
  streets.forEach((s) => {
    const o = document.createElement("option");
    o.value = s;
    o.textContent = s;
    ui.select.appendChild(o);
  });
}

function addDelivery() {
  const street = ui.select.value;
  const civico = ui.input.value.trim();
  if (!street || !civico) return;
  const isValid = DB_ZONE[currentZoneName]
    .filter((r) => r.street === street)
    .some((e) => e.civici.includes(civico));
  deliveries.push({ street, civico, isValid, completed: false });
  sortDeliveries();
  saveData();
  renderList();
  ui.input.value = "";
  ui.input.focus();
}

function sortDeliveries() {
  const ref = DB_ZONE[currentZoneName];
  deliveries.sort((a, b) => getIdx(a, ref) - getIdx(b, ref));
}

function getIdx(del, ref) {
  for (let i = 0; i < ref.length; i++) {
    if (ref[i].street === del.street) {
      const ci = ref[i].civici.indexOf(del.civico);
      return ci !== -1 ? i * 1000 + ci : i * 1000 + 999;
    }
  }
  return 999999;
}

function renderList() {
  ui.list.innerHTML = "";
  deliveries.forEach((it, i) => {
    const div = document.createElement("div");
    div.className = `delivery-card ${it.completed ? "completed" : ""} ${
      !it.isValid ? "error-card" : ""
    }`;
    div.innerHTML = `
            <div class="delivery-info">
                <span class="delivery-street">${it.street}</span>
                <span class="delivery-number">${it.civico}</span>
            </div>
            <button class="status-btn" onclick="toggleComplete(${i})">${
      it.completed ? "‚Ü©Ô∏è" : "‚úÖ"
    }</button>
        `;
    ui.list.appendChild(div);
  });
}

function toggleComplete(index) {
  if ("speechSynthesis" in window) window.speechSynthesis.cancel();
  deliveries[index].completed = !deliveries[index].completed;
  saveData();
  renderList();
  if (deliveries[index].completed) {
    trovaEAvvisaProssimo();
  }
}

// function trovaEAvvisaProssimo() {
//   const prossimo = deliveries.find((d) => !d.completed);
//   if (prossimo) {
//     const msg = `${prossimo.street} ${prossimo.civico}`;

//     // Invia notifica tramite Service Worker (Molto pi√π stabile per il Watch)
//     if (Notification.permission === "granted") {
//       inviaNotificaAlSW("üì¶ " + prossimo.civico, prossimo.street);
//     }

//     if (ui.voiceToggle.checked && "speechSynthesis" in window) {
//       const utter = new SpeechSynthesisUtterance(msg);
//       utter.lang = "it-IT";
//       window.speechSynthesis.speak(utter);
//     }
//   } else {
//     if (ui.voiceToggle.checked && "speechSynthesis" in window) {
//       window.speechSynthesis.speak(
//         new SpeechSynthesisUtterance("Giro completato")
//       );
//     }
//   }
// }

// MODIFICA la funzione trovaEAvvisaProssimo con il trucco "Musica"
function trovaEAvvisaProssimo() {
  const prossimo = deliveries.find((d) => !d.completed);
  if (prossimo) {
    const infoPerWatch = `üì¶ ${prossimo.civico} - ${prossimo.street}`;

    // TRUCCO STATO ATTIVIT√Ä (In riproduzione)
    if ("mediaSession" in navigator) {
      navigator.mediaSession.metadata = new MediaMetadata({
        title: infoPerWatch,
        artist: "Prossima Consegna",
        album: currentZoneName,
        artwork: [{ src: "icon-192.png", sizes: "192x192", type: "image/png" }],
      });

      // Avviamo un brevissimo silenzio per "svegliare" il widget sul Watch
      // Nota: serve un file audio anche di 1 secondo di silenzio totale
      audioSilenzioso.src =
        "https://github.com/anars/blank-audio/raw/master/10-seconds-of-silence.mp3";
      audioSilenzioso
        .play()
        .catch((e) => console.log("Play bloccato, serve tocco utente"));
    }

    // Sintesi vocale (Voce)
    if (ui.voiceToggle.checked && "speechSynthesis" in window) {
      const utter = new SpeechSynthesisUtterance(
        `${prossimo.street} ${prossimo.civico}`
      );
      utter.lang = "it-IT";
      window.speechSynthesis.speak(utter);
    }
  }
}

function saveData() {
  localStorage.setItem(
    `deliveries_${currentZoneName}`,
    JSON.stringify(deliveries)
  );
}
function toggleSidebar(s) {
  const open = s !== undefined ? s : !ui.sidebar.classList.contains("active");
  ui.sidebar.classList.toggle("active", open);
  ui.overlay.classList.toggle("active", open);
}
function clearZone() {
  if (confirm("Svuotare tutto?")) {
    deliveries = [];
    saveData();
    renderList();
    toggleSidebar(false);
  }
}
function printList() {
  window.print();
}

init();
